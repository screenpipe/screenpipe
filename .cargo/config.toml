[target.x86_64-pc-windows-msvc]
rustflags = [
  "-C",
  "target-feature=+crt-static",
  "-C",
  "link-args=/DEFAULTLIB:ucrt.lib /DEFAULTLIB:libvcruntime.lib libcmt.lib",
  "-C",
  "link-args=/NODEFAULTLIB:libvcruntimed.lib /NODEFAULTLIB:vcruntime.lib /NODEFAULTLIB:vcruntimed.lib",
  "-C",
  "link-args=/NODEFAULTLIB:libcmtd.lib /NODEFAULTLIB:msvcrt.lib /NODEFAULTLIB:msvcrtd.lib",
  "-C",
  "link-args=/NODEFAULTLIB:libucrt.lib /NODEFAULTLIB:libucrtd.lib /NODEFAULTLIB:ucrtd.lib",

]

[target.x86_64-unknown-linux-gnu]
rustflags = ["-C", "link-arg=-Wl,--allow-multiple-definition"]

# Force M1 target for all ARM64 macOS builds
# This prevents whisper.cpp from using i8mm instructions that only M2+ chips have
[target.aarch64-apple-darwin]
rustflags = [
    "-C", "target-cpu=apple-m1",
    "-C", "link-arg=-framework",
    "-C", "link-arg=Accelerate",
    "-l", "c++",
]

[target.x86_64-apple-darwin]
rustflags = "-lc++ -l framework=Accelerate"

[env]
CMAKE_POLICY_VERSION_MINIMUM = "3.5"

# Ensure native C/C++ dependencies (e.g. whisper.cpp/ggml) stay M1-compatible
# when building on newer Apple Silicon (M2/M3/M4). Rust target-cpu alone does
# not affect external C/C++ compilation done via cc/cmake.
CFLAGS_aarch64_apple_darwin = "-mcpu=apple-m1"
CXXFLAGS_aarch64_apple_darwin = "-mcpu=apple-m1"

# Faster builds - use more threads for codegen
[build]
jobs = 16  # Parallel compilation jobs (adjust to your CPU cores)
